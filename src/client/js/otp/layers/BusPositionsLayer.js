otp.namespace("otp.layers");

var bullRunnerIconAS = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/A.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconAN = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/ANorth.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconAE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/AEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconAW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/AWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconANE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/ANorthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconANW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/ANorthWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconASE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/ASouthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconASW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/ASouthWest.svg',
		iconSize: new L.Point(40,70)
	}
});

var bullRunnerIconBS = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/B.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconBN = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/BNorth.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconBE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/BEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconBW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/BWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconBNE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/BNorthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconBNW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/BNorthWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconBSE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/BSouthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconBSW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/BSouthWest.svg',
		iconSize: new L.Point(40,70)
	}
});

var bullRunnerIconCS = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/C.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconCN = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/CNorth.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconCE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/CEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconCW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/CWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconCNE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/CNorthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconCNW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/CNorthWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconCSE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/CSouthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconCSW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/CSouthWest.svg',
		iconSize: new L.Point(40,70)
	}
});

var bullRunnerIconDS = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/D.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconDN = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/DNorth.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconDE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/DEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconDW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/DWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconDNE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/DNorthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconDNW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/DNorthWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconDSE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/DSouthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconDSW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/DSouthWest.svg',
		iconSize: new L.Point(40,70)
	}
});

var bullRunnerIconES = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/E.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconEN = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/ENorth.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconEE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/EEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconEW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/EWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconENE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/ENorthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconENW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/ENorthWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconESE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/ESouthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconESW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/ESouthWest.svg',
		iconSize: new L.Point(40,70)
	}
});

var bullRunnerIconFS = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/F.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconFN = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/FNorth.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconFE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/FEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconFW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/FWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconFNE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/FNorthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconFNW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/FNorthWest.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconFSE = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/FSouthEast.svg',
		iconSize: new L.Point(40,70)
	}
});
var bullRunnerIconFSW = L.Icon.extend({
	options: {
		angle: 0,
		iconUrl : resourcePath + 'images/FSouthWest.svg',
		iconSize: new L.Point(40,70)
	}
});

var vehicles = {};
var stopsA = {};
var stopsB = {};
var stopsC = {};
var stopsD = {};
var stopsE = {};
var stopsF = {};

otp.layers.BusPositionsLayer = 
	otp.Class(L.LayerGroup, {

		module : null,

		minimumZoomForStops : 14,
		
		visible : [], // Bus Layers that are visible
	
		route_polylines : [],
		routes: ['A', 'B', 'C', 'D', 'E', 'F'],
	
		initialize : function(module) {
			L.LayerGroup.prototype.initialize.apply(this);
			this.module = module;

			this.module.addLayer("buses", this);
			
			//Get the stops for each Bull Runner Route to draw the route...
			stopsA = this.module.webapp.transitIndex.getTripRoute('USF Bull Runner_1');
			stopsB = this.module.webapp.transitIndex.getTripRoute('USF Bull Runner_3');
			stopsC = this.module.webapp.transitIndex.getTripRoute('USF Bull Runner_5');
			stopsD = this.module.webapp.transitIndex.getTripRoute('USF Bull Runner_8');
			stopsE = this.module.webapp.transitIndex.getTripRoute('USF Bull Runner_11');
			stopsF = this.module.webapp.transitIndex.getTripRoute('USF Bull Runner_13');

			//Use patterns API to load geometries
			for (var x=0; x < this.routes.length; x++) {
				route = this.routes[x];

				// XXX use defined agency and detect the tripid (01) ?
			        $.ajax({
                		url: otp.config.hostname + '/otp/routers/default/index/patterns/USF Bull Runner_'+route+'_01/geometries',
                		this_: this,
				rte: route,
		                dataType: 'json',
                		success: function(data) {
					this.this_.route_polylines[this.rte] = data;
				},
				});
			}

			//set map to refresh vehicle positions every 5 seconds and every map movement..
			this.module.webapp.map.lmap.on('dragend zoomend', $.proxy(this.refresh, this));
			setInterval($.proxy(this.refresh,this),5000);
		},

		refresh : function() {
			this.clearLayers();
			var lmap = this.module.webapp.map.lmap;
            var busRouteVisible = this.visible.indexOf('A') != -1 || this.visible.indexOf('B') != -1 
                                    || this.visible.indexOf('C') != -1 || this.visible.indexOf('D') != -1
                                    || this.visible.indexOf('E') != -1 || this.visible.indexOf('F') != -1;

			if(lmap.getZoom() >= this.minimumZoomForStops && busRouteVisible) {
				this.liveMap(); //need to get updated vehicle positions
				this.setRoutes(); //need to reset routes display on the map
			}
		},

		liveMap : function() {
			this_ = this;
			this.module.webapp.transitIndex.loadBusPositions(this, function(data){
				this_.vehicles = data.vehicles;
				this_.setMarkers();
			});
		},

		setMarkers: function(){
			var this_ = this;
			var v;
			var a = new Array();
			var b = new Array();
			var c = new Array();
			var d = new Array();
			var e = new Array();
			var f = new Array();
			for(v=0; v < this_.vehicles.length; v++){		
				var coord = L.latLng(this_.vehicles[v].lat,this_.vehicles[v].lon);
				var bearing = this_.vehicles[v].bearing;
				var route = this_.vehicles[v].routeId;
				var marker;

				//A Route Markers initiation
				var iconAN = new bullRunnerIconAN();
				var iconAS = new bullRunnerIconAS();
				var iconAE = new bullRunnerIconAE();
				var iconAW = new bullRunnerIconAW();
				var iconANE = new bullRunnerIconANE();
				var iconANW = new bullRunnerIconANW();
				var iconASE = new bullRunnerIconASE();
				var iconASW = new bullRunnerIconASW();
				
				//B Route Markers initiation
				var iconBN = new bullRunnerIconBN();
				var iconBS = new bullRunnerIconBS();
				var iconBE = new bullRunnerIconBE();
				var iconBW = new bullRunnerIconBW();
				var iconBNE = new bullRunnerIconBNE();
				var iconBNW = new bullRunnerIconBNW();
				var iconBSE = new bullRunnerIconBSE();
				var iconBSW = new bullRunnerIconBSW();
				
				//C Route Markers initiation
				var iconCN = new bullRunnerIconCN();
				var iconCS = new bullRunnerIconCS();
				var iconCE = new bullRunnerIconCE();
				var iconCW = new bullRunnerIconCW();
				var iconCNE = new bullRunnerIconCNE();
				var iconCNW = new bullRunnerIconCNW();
				var iconCSE = new bullRunnerIconCSE();
				var iconCSW = new bullRunnerIconCSW();
				
				//D Route Markers initiation
				var iconDN = new bullRunnerIconDN();
				var iconDS = new bullRunnerIconDS();
				var iconDE = new bullRunnerIconDE();
				var iconDW = new bullRunnerIconDW();
				var iconDNE = new bullRunnerIconDNE();
				var iconDNW = new bullRunnerIconDNW();
				var iconDSE = new bullRunnerIconDSE();
				var iconDSW = new bullRunnerIconDSW();
				
				//E Route Markers initiation
				var iconEN = new bullRunnerIconEN();
				var iconES = new bullRunnerIconES();
				var iconEE = new bullRunnerIconEE();
				var iconEW = new bullRunnerIconEW();
				var iconENE = new bullRunnerIconENE();
				var iconENW = new bullRunnerIconENW();
				var iconESE = new bullRunnerIconESE();
				var iconESW = new bullRunnerIconESW();
				
				//F Route Markers initiation
				var iconFN = new bullRunnerIconFN();
				var iconFS = new bullRunnerIconFS();
				var iconFE = new bullRunnerIconFE();
				var iconFW = new bullRunnerIconFW();
				var iconFNE = new bullRunnerIconFNE();
				var iconFNW = new bullRunnerIconFNW();
				var iconFSE = new bullRunnerIconFSE();
				var iconFSW = new bullRunnerIconFSW();
				
				
				switch (route){
				case 'A':
					switch(bearing){
					case 0:
						marker =  L.marker(coord,{icon : iconAN,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						a.push(marker);
						break;
					case 45:
						marker=L.marker(coord,{icon : iconANE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						a.push(marker);
						break;
					case 90:
						marker = L.marker(coord,{icon : iconAE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						a.push(marker);
						break;
					case 135:
						marker = L.marker(coord,{icon : iconASE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						a.push(marker);
						break;
					case 180:
						marker = L.marker(coord,{icon : iconAS,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						a.push(marker);
						break;
					case 225:
						marker = L.marker(coord,{icon : iconASW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						a.push(marker);
						break;
					case 270:
						marker = L.marker(coord,{icon : iconAW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						a.push(marker);
						break;
					case 315:
						marker = L.marker(coord,{icon : iconANW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						a.push(marker);
						break;
					default:
						console.log("Error no dir available: " + route);
					}
					break;
				case 'B':
					switch(bearing){
					case 0:
						marker =  L.marker(coord,{icon : iconBN,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						b.push(marker);
						break;
					case 45:
						marker=L.marker(coord,{icon : iconBNE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						b.push(marker);
						break;
					case 90:
						marker = L.marker(coord,{icon : iconBE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						b.push(marker);
						break;
					case 135:
						marker = L.marker(coord,{icon : iconBSE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						b.push(marker);
						break;
					case 180:
						marker = L.marker(coord,{icon : iconBS,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						b.push(marker);
						break;
					case 225:
						marker = L.marker(coord,{icon : iconBSW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						b.push(marker);
						break;
					case 270:
						marker = L.marker(coord,{icon : iconBW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						b.push(marker);
						break;
					case 315:
						marker = L.marker(coord,{icon : iconBNW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						b.push(marker);
						break;
					default:
						console.log("Error no dir available: " + route);
					}
					break;
				case 'C':
					switch(bearing){
					case 0:
						marker =  L.marker(coord,{icon : iconCN,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						c.push(marker);
						break;
					case 45:
						marker=L.marker(coord,{icon : iconCNE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						c.push(marker);
						break;
					case 90:
						marker = L.marker(coord,{icon : iconCE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						c.push(marker);
						break;
					case 135:
						marker = L.marker(coord,{icon : iconCSE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						c.push(marker);
						break;
					case 180:
						marker = L.marker(coord,{icon : iconCS,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						c.push(marker);
						break;
					case 225:
						marker = L.marker(coord,{icon : iconCSW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						c.push(marker);
						break;
					case 270:
						marker = L.marker(coord,{icon : iconCW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						c.push(marker);
						break;
					case 315:
						marker = L.marker(coord,{icon : iconCNW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						c.push(marker);
						break;
					default:
						console.log("Error no dir available: " + route);
					}
					break;
				case 'D':
					switch(bearing){
					case 0:
						marker =  L.marker(coord,{icon : iconDN,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						d.push(marker);
						break;
					case 45:
						marker=L.marker(coord,{icon : iconDNE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						d.push(marker);
						break;
					case 90:
						marker = L.marker(coord,{icon : iconDE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						d.push(marker);
						break;
					case 135:
						marker = L.marker(coord,{icon : iconDSE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						d.push(marker);
						break;
					case 180:
						marker = L.marker(coord,{icon : iconDS,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						d.push(marker);
						break;
					case 225:
						marker = L.marker(coord,{icon : iconDSW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						d.push(marker);
						break;
					case 270:
						marker = L.marker(coord,{icon : iconDW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						d.push(marker);
						break;
					case 315:
						marker = L.marker(coord,{icon : iconDNW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						d.push(marker);
						break;
					default:
						console.log("Error no dir available: " + route);
					}
					break;
				case 'E':
					switch(bearing){
					case 0:
						marker =  L.marker(coord,{icon : iconEN,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						e.push(marker);
						break;
					case 45:
						marker=L.marker(coord,{icon : iconENE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						e.push(marker);
						break;
					case 90:
						marker = L.marker(coord,{icon : iconEE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						e.push(marker);
						break;
					case 135:
						marker = L.marker(coord,{icon : iconESE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						e.push(marker);
						break;
					case 180:
						marker = L.marker(coord,{icon : iconES,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						e.push(marker);
						break;
					case 225:
						marker = L.marker(coord,{icon : iconESW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						e.push(marker);
						break;
					case 270:
						marker = L.marker(coord,{icon : iconEW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						e.push(marker);
						break;
					case 315:
						marker = L.marker(coord,{icon : iconENW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						e.push(marker);
						break;
					default:
						console.log("Error no dir available: " + route);
					}
					break;
				case 'F':
					switch(bearing){
					case 0:
						marker =  L.marker(coord,{icon : iconFN,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						f.push(marker);
						break;
					case 45:
						marker=L.marker(coord,{icon : iconFNE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						f.push(marker);
						break;
					case 90:
						marker = L.marker(coord,{icon : iconFE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						f.push(marker);
						break;
					case 135:
						marker = L.marker(coord,{icon : iconFSE,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						f.push(marker);
						break;
					case 180:
						marker = L.marker(coord,{icon : iconFS,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						f.push(marker);
						break;
					case 225:
						marker = L.marker(coord,{icon : iconFSW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						f.push(marker);
						break;
					case 270:
						marker = L.marker(coord,{icon : iconFW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						f.push(marker);
						break;
					case 315:
						marker = L.marker(coord,{icon : iconFNW,}).bindPopup('Bus: ' + this_.vehicles[v].id + " Route: " + route);
						marker.on('mouseover', marker.openPopup.bind(marker));
						f.push(marker);
						break;
					default:
						console.log("Error no dir available: " + route);
					}
					break;
				default:
					console.log("Error no route available: " + route);
				}
			}
			
			if (this.visible.indexOf('A') != -1) L.layerGroup(a).addTo(this_);
			if (this.visible.indexOf('B') != -1) L.layerGroup(b).addTo(this_);
			if (this.visible.indexOf('C') != -1) L.layerGroup(c).addTo(this_);
			if (this.visible.indexOf('D') != -1) L.layerGroup(d).addTo(this_);
			if (this.visible.indexOf('E') != -1) L.layerGroup(e).addTo(this_);
			if (this.visible.indexOf('F') != -1) L.layerGroup(f).addTo(this_);
		},
		
		setRoutes : function(){			
			//for route A:
			var routeA = new Array();
			//console.log(stopsA);
			for (var a = 0; a < stopsA.length; a++){
				var lat = stopsA[a].lat;
				var lng = stopsA[a].lon;
				var latlng = L.latLng(lat, lng);
				routeA.push(latlng);
			}
			
			//for route B:
			var routeB = new Array();
			for (var b = 0; b < stopsB.length; b++){
				var lat = stopsB[b].lat;
				var lng = stopsB[b].lon;
				var latlng = L.latLng(lat, lng);
				routeB.push(latlng);
			}
			
			//for route C:
			var routeC = new Array();
			for (var c = 0; c < stopsC.length; c++){
				var lat = stopsC[c].lat;
				var lng = stopsC[c].lon;
				var latlng = L.latLng(lat, lng);
				routeC.push(latlng);
			}
			
			//for route D:
			var routeD = new Array();
			for (var d = 0; d < stopsD.length; d++){
				var lat = stopsD[d].lat;
				var lng = stopsD[d].lon;
				var latlng = L.latLng(lat, lng);
				routeD.push(latlng);
			}			
			
			//for route E:
			var routeE = new Array();
			for (var e = 0; e < stopsE.length; e++){
				var lat = stopsE[e].lat;
				var lng = stopsE[e].lon;
				var latlng = L.latLng(lat, lng);
				routeE.push(latlng);
			}
						
			//for route F:
			var routeF = new Array();
			for (var f = 0; f < stopsF.length; f++){
				var lat = stopsF[f].lat;
				var lng = stopsF[f].lon;
				var latlng = L.latLng(lat, lng);
				routeF.push(latlng);
			}

			if (this.visible.indexOf('A') != -1) this.drawRoutePolyline(this.route_polylines['A'], {color: '#00573C'} );

			if (this.visible.indexOf('B') != -1) this.drawRoutePolyline(this.route_polylines['B'], {color: '#0077D1'} );

			if (this.visible.indexOf('C') != -1) this.drawRoutePolyline(this.route_polylines['C'], {color: '#AC49D0'} );

			if (this.visible.indexOf('D') != -1) this.drawRoutePolyline(this.route_polylines['D'], {color: '#F70505'} );

			if (this.visible.indexOf('E') != -1) this.drawRoutePolyline(this.route_polylines['E'], {color: '#bca510'} );

			if (this.visible.indexOf('F') != -1) this.drawRoutePolyline(this.route_polylines['F'], {color: '#8F6A51'} );

		},

		drawRoutePolyline : function(route, opts) {

			for (x in route) {
				line = route[x]
				L.polyline(otp.util.Geo.decodePolyline(line['points']), opts).addTo(this);
			}
		},

	});
